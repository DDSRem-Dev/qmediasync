import{d as h,i as w,y as V,r as y,b as c,c as z,k as r,e as t,w as l,u as o,g as M,E as n,D as q,S as D,j as B,G as T,m as d,H as A,x as m,A as G,C as N,h as P,_ as I}from"./index-BXBNiAnl.js";const L={class:"backup-restore-container"},$={class:"action-buttons"},j={key:0,class:"file-info"},U=0,W=h({__name:"AppBackupRestore",setup(H){const v=w("$http"),p=V(),S=P(),f=y(),s=y(null),_=y(!1),E=a=>{var u,i;const e=a.raw;if(!e)return;if(![".sql",".zip"].some(x=>e.name.toLowerCase().endsWith(x))){n.error("只支持 .sql 或 .zip 格式的文件"),(u=f.value)==null||u.clearFiles();return}if(e.size>1073741824){n.error("文件大小不能超过 1GB"),(i=f.value)==null||i.clearFiles();return}s.value=e,n.success("文件已选择")},R=a=>{a.length>0&&n.warning("每次只能上传一个备份文件")},k=()=>{var a;s.value=null,(a=f.value)==null||a.clearFiles(),n.info("已清除选择的文件")},F=async()=>{if(!(!s.value||!v))try{await q.confirm("此操作将覆盖当前数据库，数据库将暂时不可用，确认继续吗？","危险操作确认",{confirmButtonText:"确认恢复",cancelButtonText:"取消",type:"error",confirmButtonClass:"el-button--danger"}),_.value=!0;const a=new FormData;a.append("file",s.value);const e=await v.post(`${D}/backup/upload-restore`,a,{headers:{"Content-Type":"multipart/form-data"}});e.data.code===U?(n.success("恢复任务已启动"),p.startProgressPolling("restore",void 0,v),k()):n.error(e.data.message||"启动恢复任务失败")}catch(a){if(a!=="cancel"){const e=a instanceof Error?a.message:"启动恢复任务失败";n.error(e)}}finally{_.value=!1}};return(a,e)=>{const b=c("el-alert"),g=c("el-icon"),C=c("el-upload"),u=c("el-button"),i=c("el-descriptions-item"),x=c("el-descriptions");return B(),z("div",L,[e[4]||(e[4]=r("div",{class:"page-header"},[r("span",null,"数据库恢复")],-1)),t(b,{title:"警告：数据库恢复操作将覆盖当前数据库，请谨慎操作！",type:"error",closable:!1,style:{"margin-bottom":"20px"}}),t(b,{title:"恢复说明：仅支持 .sql 或 .zip 格式的备份文件，文件大小不超过 1GB",type:"info",closable:!1,style:{"margin-bottom":"20px"}}),t(C,{ref_key:"uploadRef",ref:f,action:"#","auto-upload":!1,limit:1,accept:".sql,.zip","on-change":E,"on-exceed":R,disabled:o(p).isRunning,drag:""},{tip:l(()=>e[0]||(e[0]=[r("div",{class:"el-upload__tip"}," 只支持 .sql / .zip 文件，且不超过 1GB ",-1)])),default:l(()=>[t(g,{class:"el-icon--upload"},{default:l(()=>[t(o(T))]),_:1}),e[1]||(e[1]=r("div",{class:"el-upload__text"},[d(" 将备份文件拖到此处，或"),r("em",null,"点击选择文件")],-1))]),_:1},8,["disabled"]),r("div",$,[t(u,{type:"primary",size:"large",loading:_.value,disabled:!s.value||o(p).isRunning,onClick:F},{default:l(()=>[t(g,null,{default:l(()=>[t(o(A))]),_:1}),e[2]||(e[2]=r("span",null,"开始恢复",-1))]),_:1},8,["loading","disabled"]),t(u,{size:"large",disabled:!s.value||_.value||o(p).isRunning,onClick:k},{default:l(()=>e[3]||(e[3]=[d(" 清除 ")])),_:1},8,["disabled"])]),s.value?(B(),z("div",j,[t(x,{column:o(S)?1:2,border:""},{default:l(()=>[t(i,{label:"文件名"},{default:l(()=>[d(m(s.value.name),1)]),_:1}),t(i,{label:"文件大小"},{default:l(()=>[d(m(o(G)(s.value.size)),1)]),_:1}),t(i,{label:"文件类型"},{default:l(()=>[d(m(s.value.name.endsWith(".zip")?"ZIP 压缩":"SQL"),1)]),_:1}),t(i,{label:"最后修改"},{default:l(()=>[d(m(o(N)(s.value.lastModified/1e3)),1)]),_:1})]),_:1},8,["column"])])):M("",!0)])}}}),Q=I(W,[["__scopeId","data-v-2aff8b6d"]]);export{Q as default};
